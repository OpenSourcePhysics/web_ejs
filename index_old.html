<html>
  <head>
    <link rel="stylesheet" href="./assets/bootstrap/bootstrap.min.css">
    <link rel="stylesheet" href="./assets/bootstrap/bootstrap-icons.css"> 

    <script src="./assets/bootstrap/bootstrap.bundle.min.js"></script>
    <script src="./assets/jquery/jquery-3.6.1.min.js"></script>
    
    <title>Web EJS run page</title>

		<link rel="stylesheet" href="./assets/WebEJS/gui.css" %}">


  </head>
  <body class="h-100">

    <!--  NAVBAR-BRAND -->

    <span class="navbar-brand">
			<span class="sFullText sMainWebEJSlogo">
				<img  src="./assets/WebEJS/icons/WebEJS_logo.png" height="40" 
							class="sFullText mt-2 mx-0 d-inline-block align-bottom align-items-center"><span>WebEJS</span></img>
			</span>
    </span>	

    <div class="text-center align-middle mt-3">
      <img src="./assets/WebEJS/icons/WebEJS_logo.png" width=200 class="d-inline-block align-bottom;"/>
      <h4 class="mb-3">Welcome to WebEJS</h4>
      <h5 class="mb-3">Served by : <a href='https://www.um.es' target='_blank'>Universidad de Murcia, Spain</a></h5>
      <h4 class="mb-3 text-danger">This is a BETA version of WebEJS</h4>
      <hr/>
      <div class="mt-3 fs-3">
        List of available servers: 
      </div>
      <div id="mSearchingField" class="mt-3 text-primary fs-4">
        <div id="mNoServerNotice" class="mt-3" >
          No server found yet. Still searching... 
        </div>
        <ul id="mServerList" class="mt-3 fs-4">
        </ul>
        <div id="mServerFound" class="d-none fs-6">
          Click on a server button to proceed.
        </div>
      </div>
      <div id="mSecondsField" class="mt-3 fs-6">
        Searching for 10 more seconds...
      </div>

      <hr/>      
      <!--h6 class="mb-3">You can also try one of these examples:</h6>
      <ul>
        <li class="mb-3" style="list-style-type: none;">
          <a href="https://macmath.inf.um.es/editor?name=Bungee%20Jump&url=https%3A//www.compadre.org/osp/document/ServeFile.cfm%3FID%3D13284%26DocID%3D3826%26EJSSource%3D1">
            Bungee Jump
          </a>
        </li>
        <li class="mb-3" style="list-style-type: none;">
          <a href="https://macmath.inf.um.es/editor?name=Half%20Atwood%20Machine&url=https%3A//www.compadre.org/osp/document/ServeFile.cfm%3FID%3D12976%26DocID%3D3554%26EJSSource%3D1">
            Half Atwood Machine
          </a>
        </li>
      </ul-->
    </div>
    <script type='text/javascript' id='clustrmaps' src='//cdn.clustrmaps.com/map_v2.js?cl=ffffff&w=386&t=n&d=Tidox0Or6RCm6D3QoGaure5UCtdHxj00so9xs5v9Rkw'></script>  </body>
    <script>

    const SERVER_LIST = [ 
      { name: 'EjsCloud' , url : "https://ejscloud.inf.um.es", comment:'EjsCloud uses WebEJS 1.0' },
      { name: 'MacMath' , url : "https://macmath.inf.um.es", comment:'MacMath uses WebEJS 0.1'},
      { name: 'SilverSurfer' , url : "https://silversurfer.inf.um.es", comment:'SilverSurfer uses WebEJS 1.0' },
    ];

    var nServers = 0;

    // -------------------------------
    // Checking and adding servers
    // -------------------------------

    function addServer(server) {
      var html = '<li class="mt-2 text-primary fs-6">';
      html += '<button type="button" class="cServerItem btn btn-primary me-2" data-url="'+server.url+'">'+server.name+'</button>';
      html += server.comment;
      html += '</li>';

      var li = $(html).on('click',(event) => {
        goToServer(server.url);
      });

      $('#mServerList').append(li);
      $('#mNoServerNotice').addClass("d-none");
      $('#mServerFound').removeClass("d-none");

      nServers++;
    }
    
    function checkServer(server) {
      var isWorking = false;
      $.ajax(server.url, {
        statusCode: {
          404: function() {
            console.log("Server not available: "+server.name);
          },
          200: function() {
            $('#mNoServerNotice').addClass("d-none");
            console.log("Server available!!!: ")
            console.log(server);            
            addServer(server);
          }
        }
      });
    }

    // -------------------------------
    // Redirecting to a server
    // -------------------------------

    function urlParam(name) {
        var results = new RegExp('[\?&]' + name + '=([^&#]*)').exec(window.location.search);
        return (results !== null) ? results[1] || 0 : false;
      }  

    function goToServer(serverUrl) {
      var postMessage = '';
        var modelURL = urlParam('url');
        if (modelURL) {
          postMessage += '?url=' + modelURL;
          var modelName = urlParam('name');
          if (modelName && modelName.trim().length > 0) postMessage += "&name=" + modelName;
        }
        //alert ("New href = "+availableServerURL + '/editor' + postMessage);
        window.location.href = serverUrl + '/editor' + postMessage;
      }

    // -------------------------
    // Timeout for the search
    // -------------------------

    var counter = 10;

    function timeOutCounter() {
      counter--;
      $('#mSecondsField').text('Searching for '+counter+' more seconds...');
      if (counter>0) setTimeout(timeOutCounter, 1000);
      else {
        $('#mSecondsField').addClass('d-none');
        if (nServers<=0) {
          $('#mSearchingField').text('We are sorry. We could not find an available server. Please, try later!');
          $('#mSearchingField').addClass('text-danger');
        }
      }
    }

    // -------------------------
    // Here we go
    // -------------------------

    setTimeout(timeOutCounter, 1000);
    for (var index in SERVER_LIST) checkServer(SERVER_LIST[index])

    </script>

</html>